<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Distributed computing with Celery - mike.depalatis.net</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="../drafts/distributed-computing-with-celery.html">

        <meta name="author" content="Michael V. DePalatis" />
        <meta name="keywords" content="python,celery" />
        <meta name="description" content="Python, although an interpreted language, remains reasonably fast for numerical computations via Numpy and related libraries thanks to their compiled cores. This allows certain operations to be executed at near-native speed; close enough, in many cases, that there are no significant gains to using a compiled language like C directly ..." />

    <!-- Enable latex plugin -->




    <!-- Bootstrap -->
        <link rel="stylesheet" href="../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="../theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="../theme/css/style.css" type="text/css"/>




</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../" class="navbar-brand">
mike.depalatis.net            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="../">
                             About
                          </a></li>
                         <li><a href="../photography.html">
                             Photography
                          </a></li>
                         <li><a href="../research.html">
                             Research
                          </a></li>
                         <li><a href="../resources.html">
                             Links
                          </a></li>
                        <li class="active">
                            <a href="../category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="../archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-lg-12">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="../drafts/distributed-computing-with-celery.html"
                       rel="bookmark"
                       title="Permalink to Distributed computing with Celery">
                        Distributed computing with Celery
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-08-06T00:00:00+02:00"> 2015-08-06</time>
    </span>






<span class="label label-default">Tags</span>
	<a href="../tag/python.html">python</a>
        /
	<a href="../tag/celery.html">celery</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Python, although an interpreted language, remains reasonably fast for
numerical computations via <a class="reference external" href="http://www.numpy.org/">Numpy</a> and related libraries thanks to
their compiled cores. This allows certain operations to be executed at
near-native speed; close enough, in many cases, that there are no
significant gains to using a compiled language like C directly. That
is, provided for loops can be avoided in favor of Numpy array slicing
expressions. Unfortunately, for loops can't always be avoided for
<a class="reference external" href="https://en.wikipedia.org/wiki/Embarrassingly_parallel">embarrassingly parallel</a> problems such as <a class="reference external" href="https://en.wikipedia.org/wiki/Monte_Carlo_method">Monte Carlo
simulations</a>.</p>
<p>Thankfully, modern PCs usually have multiple cores, and with
networking, the number of available cores to tackle an embarrassingly
parallel problem can increase rapidly. A number of tools exist for
parallel processing in Python: the standard library's
<tt class="docutils literal">multiprocessing</tt> module or the parallel computing architecture of
<a class="reference external" href="http://ipython.org/">IPython</a>, among others. IPython's parallel computing model is
exceptional, but it suffers from being rather complex to get things
setup on multiple computers or even for having the right things
imported.</p>
<p>Another tool which makes parallel computing with small, ad hoc
clusters is <a class="reference external" href="http://www.celeryproject.org/">Celery</a>. Celery is a distributed task queue which is
commonly used among web developers to offload potentially long-running
tasks from web servers which can then focus on responding to requests
as quickly as they come in. A simplistic overview of using Celery for
parallel computing is as follows:</p>
<ul class="simple">
<li>A central script (let's call it the hub) decides what parallel
computations need to be performed and submits these tasks in chunks
to a centralized message broker.</li>
<li>A number of workers are deployed on as many computers as are
available that can talk to the broker. The workers crunch the
numbers and store their results in a configured results backend.</li>
<li>The hub aggregates the results from the backend into a final form,
or distributes to other workers for further processing.</li>
</ul>
<p>The nice thing about using Celery in this model is that it does almost
all of the heavy lifting: to tackle an embarrassingly parallel
problem, you only need to install a broker and a backend and start the
workers running on all the computers you can get your hands on.</p>
<p>As an example, let's consider a classic Monte Carlo demonstration
problem: estimating <span class="formula"><i>pi</i></span>. Imagine a square with a side of length
1 inscribed with the first quadrant of the unit circle. If we throw
darts at the board, we can count how many land within the inscribed
circle and how many land outside. The area of the circle is given by</p>
<div class="formula">
<i>A</i> = <span class="fraction"><span class="ignored">(</span><span class="numerator">1</span><span class="ignored">)/(</span><span class="denominator">4</span><span class="ignored">)</span></span><i>π</i>
</div>
<p>This means that, assuming all darts hit the board, the probability of
a randomly thrown dart landing within the circle is the same as the
area. Therefore, we can estimate <span class="formula"><i>π</i></span> by throwing enough darts:</p>
<div class="formula">
<i>π</i> ≈ 4<span class="fraction"><span class="ignored">(</span><span class="numerator"><i>M</i></span><span class="ignored">)/(</span><span class="denominator"><i>N</i></span><span class="ignored">)</span></span>
</div>
<p>where <span class="formula"><i>M</i></span> is the number of darts landing within the circle, and
<span class="formula"><i>N</i></span> the total number of darts thrown <a class="footnote-reference" href="#id4" id="id1">[1]</a>. With a random number
generator, implementing a program to estimate <span class="formula"><i>π</i></span> in this
manner is straightforward <a class="footnote-reference" href="#id5" id="id2">[2]</a>. For comparison, we should start with
the most naive approach possible, which is just using a for loop to
throw darts in sequence:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">try_point</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Throws a single dart and returns 1 if inside the target region,</span>
<span class="sd">    else 0.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>

<span class="k">def</span> <span class="nf">estimate_pi_naive</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Naively estimate pi.&quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting with naive single-threaded Python...&quot;</span><span class="p">)</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">inside</span> <span class="o">+=</span> <span class="n">try_point</span><span class="p">(</span><span class="n">random</span><span class="p">((</span><span class="mi">2</span><span class="p">,)))</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inside</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;pi is approximately&quot;</span><span class="p">,</span> <span class="n">process_results</span><span class="p">(</span><span class="n">inside</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
<p>Now let's do this in parallel with celery. Because using celery
requires some network transport, we don't want to use a task that
throws just one dart, but instead have each celery worker throw
several darts <a class="footnote-reference" href="#id6" id="id3">[3]</a>. The Python code defining the celery task is again
straightforward:</p>
<div class="highlight"><pre><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">try_points</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Throws N darts and returns the number that landed inside the</span>
<span class="sd">    target region. Separated from the celery task in order to work</span>
<span class="sd">    more easily with IPython&#39;s parallel model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">random</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">inside</span> <span class="o">+=</span> <span class="n">try_point</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inside</span>
</pre></div>
<div class="section" id="footnotes">
<h2>Footnotes</h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>For a more formal explanation, see <a class="reference external" href="http://mathfaculty.fullerton.edu/mathews/n2003/montecarlopimod.html">here</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Full code for the examples is available on <a class="reference external" href="https://gist.github.com/mivade/8e374f1a8e42a92a43ff">Github</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>The exact balance of how you should group things is dependent
on the problem. In practice, you would have to play around with
the group size until you find a good number to use.</td></tr>
</tbody>
</table>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Michael V. DePalatis
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="../theme/js/jquery.min.js"></script>
<script src="../theme/js/bootstrap.min.js"></script>
<script src="../theme/js/respond.min.js"></script>
<script src="../theme/js/admonitions.js"></script>

</body>
</html>